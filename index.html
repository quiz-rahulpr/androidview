<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Portal - Mobile</title>
    <style>
        :root { --primary: #2c3e50; --success: #27ae60; --danger: #e74c3c; --accent: #3498db; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background: #f4f7f9; 
            overscroll-behavior: contain;
        }

        /* Login Screen */
        #login-screen { 
            padding: 40px 20px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            height: 80vh; 
        }
        
        input[type="text"] { 
            width: 100%; 
            padding: 15px; 
            margin: 20px 0; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 16px; /* Prevents iOS zoom */
        }

        /* Header & Timer */
        header {
            background: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .timer { font-size: 1.4rem; color: var(--danger); font-weight: bold; font-family: monospace; }

        /* Main Content */
        #main-content { padding: 15px; padding-bottom: 100px; }
        #q-text { font-size: 1.1rem; color: var(--primary); line-height: 1.5; margin-bottom: 20px; }

        .option-card { 
            display: block; 
            width: 100%; 
            padding: 16px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            background: white; 
            text-align: left; 
            font-size: 1rem;
            transition: 0.2s; 
            -webkit-tap-highlight-color: transparent;
        }
        .selected { background: #e3f2fd !important; border-color: var(--accent) !important; font-weight: bold; }

        /* Navigation Footer */
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            padding: 10px;
            box-sizing: border-box;
            gap: 8px;
        }

        .btn-nav { flex: 1; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 0.9rem; color: white; background: #666; }
        .btn-next { background: var(--accent); }
        .btn-finish { background: var(--danger); }
        .btn-palette { background: var(--primary); }

        /* Sidebar / Palette */
        #sidebar { 
            position: fixed; 
            right: 0; 
            top: 0; 
            width: 80%; 
            max-width: 300px;
            height: 100%; 
            background: white; 
            z-index: 50; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: 0.3s transform ease;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        #sidebar.open { transform: translateX(0); }
        
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 40;
        }
        .overlay.active { display: block; }

        .q-circle { 
            width: 40px; 
            height: 40px; 
            border-radius: 6px; 
            border: 1px solid #ccc; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            margin: 5px; 
            font-weight: bold; 
            font-size: 0.8rem;
        }
        .attempted { background: var(--success) !important; color: white; border: none; }
        .current { border: 2px solid var(--accent); background: #f0f7ff; }

        .hidden { display: none; }
        #final-screen { text-align: center; padding: 50px 20px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div style="background: white; padding: 30px; border-radius: 15px; shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 style="color: var(--primary)">Candidate Login</h2>
            <input type="text" id="username" placeholder="Enter Full Name">
            <button class="btn-nav btn-next" style="width: 100%;" onclick="startExam()">Enter Exam Hall</button>
        </div>
    </div>

    <div id="exam-container" class="hidden">
        <header>
            <div class="timer" id="timer-display">30:00</div>
            <button class="btn-nav btn-palette" style="padding: 8px 15px; flex: none;" onclick="togglePalette()">Q-Palette</button>
        </header>

        <main id="main-content">
            <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee;">
                <h2 id="q-text">Question Loading...</h2>
                <div id="options-container"></div>
            </div>
        </main>

        <footer>
            <button class="btn-nav" onclick="changeQuestion(-1)">PREV</button>
            <button class="btn-nav btn-next" onclick="changeQuestion(1)">NEXT</button>
            <button class="btn-nav btn-finish" onclick="finishExam()">FINISH</button>
        </footer>
    </div>

    <div id="overlay" class="overlay" onclick="togglePalette()"></div>
    <div id="sidebar">
        <h3>Question Palette</h3>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <div id="question-grid"></div>
        <div style="margin-top: 30px; font-size: 0.8rem;">
            <p><span style="color: var(--success)">●</span> Attempted</p>
            <p><span style="color: #ccc">●</span> Unattempted</p>
            <p><span style="color: var(--accent)">□</span> Current Focus</p>
        </div>
        <button class="btn-nav" style="width: 100%; margin-top: 20px;" onclick="togglePalette()">Close</button>
    </div>

    <div id="final-screen" class="hidden">
        <div style="background: white; padding: 40px 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
            <h1 style="color: var(--success);">Submitted!</h1>
            <p>Your responses have been recorded securely. The rank list will be published soon.</p>
            <button class="btn-nav btn-next" style="margin-top: 20px; width: 100%;" onclick="location.reload()">Return Home</button>
        </div>
    </div>

    <script type="module">
        import { quizQuestions } from './questions.js';
        
        let currentIdx = 0;
        let userAnswers = new Array(quizQuestions.length).fill(null);
        let timeLeft = 30 * 60; // Defaulting to 30 mins as per your request
        let timerInterval;

        const FORM_ID = "1FAIpQLSfdc6KygQ100hICyXkaJYIWVJ7UxKYUw4aV22smmT3nRWCu3g"; 
        const ENTRY_NAME = "entry.1088098272";
        const ENTRY_SCORE = "entry.1899459571";
        const ENTRY_TIME = "entry.1956296565";

        window.startExam = function() {
            const name = document.getElementById('username').value;
            if(!name) return alert("Enter your name to proceed");
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('exam-container').classList.remove('hidden');
            renderGrid();
            showQuestion();
            startTimer();
        };

        function renderGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const btn = document.createElement('div');
                btn.className = 'q-circle';
                btn.id = `grid-q-${i}`;
                btn.innerText = i + 1;
                btn.onclick = () => { currentIdx = i; showQuestion(); togglePalette(); };
                grid.appendChild(btn);
            });
        }

        function showQuestion() {
            const q = quizQuestions[currentIdx];
            document.getElementById('q-text').innerText = `Q${currentIdx + 1}: ${q.question}`;
            const container = document.getElementById('options-container');
            container.innerHTML = '';

            document.querySelectorAll('.q-circle').forEach(el => el.classList.remove('current'));
            const currentCircle = document.getElementById(`grid-q-${currentIdx}`);
            if(currentCircle) currentCircle.classList.add('current');

            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `option-card ${userAnswers[currentIdx] === i ? 'selected' : ''}`;
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                container.appendChild(btn);
            });
        }

        function selectOption(optIdx) {
            userAnswers[currentIdx] = optIdx;
            document.getElementById(`grid-q-${currentIdx}`).classList.add('attempted');
            showQuestion();
        }

        window.changeQuestion = function(step) {
            let newIdx = currentIdx + step;
            if(newIdx >= 0 && newIdx < quizQuestions.length) {
                currentIdx = newIdx;
                showQuestion();
                window.scrollTo(0,0);
            }
        };

        window.togglePalette = function() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        };

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                document.getElementById('timer-display').innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
                if(timeLeft <= 0) finishExam();
            }, 1000);
        }

        window.finishExam = function() {
            if(timeLeft > 0 && !confirm("Are you sure you want to submit?")) return;
            
            clearInterval(timerInterval);
            
            let total = 0;
            userAnswers.forEach((ans, i) => {
                if(ans === null) return; 
                if(ans === quizQuestions[i].correct) total += 1;
                else total -= (1/3);
            });

            const finalScore = total.toFixed(2);
            const name = document.getElementById('username').value;
            const timeTaken = `${30 - Math.ceil(timeLeft/60)} mins`;

            const url = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?` + 
                        `${ENTRY_NAME}=${encodeURIComponent(name)}&` +
                        `${ENTRY_SCORE}=${finalScore}&` +
                        `${ENTRY_TIME}=${encodeURIComponent(timeTaken)}&submit=Submit`;

            fetch(url, { mode: 'no-cors' });

            document.getElementById('exam-container').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
        };
    </script>
</body>
</html>
