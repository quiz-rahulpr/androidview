<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mobile Quiz Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .unattempted { background-color: #e5e7eb; }
        .attempted { background-color: #3b82f6; color: white; }
        body { touch-action: manipulation; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="auth-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6">
        <h1 class="text-2xl font-bold mb-6 text-blue-600">Entrance Exam</h1>
        <input type="text" id="user-name" placeholder="Enter Full Name" class="w-full border-2 border-blue-500 rounded-lg p-3 mb-4 outline-none">
        <button onclick="startQuiz()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg">START EXAM</button>
    </div>

    <div id="quiz-container" class="hidden h-screen flex flex-col">
        <header class="bg-blue-700 text-white p-4 flex justify-between items-center sticky top-0">
            <div id="timer" class="text-xl font-mono font-bold">30:00</div>
            <button onclick="toggleSidebar()" class="bg-blue-800 px-3 py-1 rounded">Q-Panel</button>
        </header>

        <main class="flex-grow p-4 overflow-y-auto">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                <p id="q-number" class="text-sm text-gray-500 mb-2 font-bold"></p>
                <p id="q-text" class="text-lg font-medium mb-6"></p>
                <div id="options-container" class="space-y-3">
                    </div>
            </div>
        </main>

        <footer class="p-4 bg-white border-t flex justify-between gap-4">
            <button onclick="prevQuestion()" class="flex-1 bg-gray-200 py-3 rounded-lg font-bold">PREV</button>
            <button onclick="nextQuestion()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold">NEXT</button>
            <button onclick="submitQuiz()" class="flex-1 bg-red-600 text-white py-3 rounded-lg font-bold">FINISH</button>
        </footer>
    </div>

    <div id="sidebar" class="fixed inset-y-0 right-0 w-64 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-40 p-4">
        <h3 class="font-bold mb-4 border-b pb-2">Questions</h3>
        <div id="q-grid" class="grid grid-cols-4 gap-2">
            </div>
        <button onclick="toggleSidebar()" class="mt-6 w-full py-2 bg-gray-800 text-white rounded">Close Panel</button>
    </div>

    <script type="module">
        import { quizQuestions } from './questions.js';

        // Config
        const FORM_ID = "1FAIpQLSfdc6KygQ100hICyXkaJYIWVJ7UxKYUw4aV22smmT3nRWCu3g";
        const ENTRIES = {
            name: "entry.1088098272",
            score: "entry.1899459571",
            time: "entry.1956296565"
        };

        let currentIdx = 0;
        let answers = new Array(quizQuestions.length).fill(null);
        let timeLeft = 30 * 60; // 30 mins in seconds
        let userName = "";

        // UI Functions
        window.startQuiz = () => {
            userName = document.getElementById('user-name').value;
            if(!userName) return alert("Enter your name");
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('quiz-container').classList.remove('hidden');
            renderQuestion();
            renderGrid();
            startTimer();
        };

        function renderQuestion() {
            const q = quizQuestions[currentIdx];
            document.getElementById('q-number').innerText = `Question ${currentIdx + 1}/${quizQuestions.length}`;
            document.getElementById('q-text').innerText = q.question;
            
            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-4 rounded-lg border-2 transition ${answers[currentIdx] === i ? 'border-blue-500 bg-blue-50' : 'border-gray-100'}`;
                btn.innerText = opt;
                btn.onclick = () => selectOption(i);
                optionsDiv.appendChild(btn);
            });
        }

        function selectOption(idx) {
            answers[currentIdx] = idx;
            renderQuestion();
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('q-grid');
            grid.innerHTML = '';
            quizQuestions.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `h-10 w-10 flex items-center justify-center rounded-md text-sm font-bold cursor-pointer ${answers[i] !== null ? 'attempted' : 'unattempted'}`;
                dot.innerText = i + 1;
                dot.onclick = () => { currentIdx = i; renderQuestion(); toggleSidebar(); };
                grid.appendChild(dot);
            });
        }

        window.nextQuestion = () => { if(currentIdx < quizQuestions.length - 1) { currentIdx++; renderQuestion(); } };
        window.prevQuestion = () => { if(currentIdx > 0) { currentIdx--; renderQuestion(); } };
        window.toggleSidebar = () => {
            const side = document.getElementById('sidebar');
            side.classList.toggle('translate-x-full');
        };

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const interval = setInterval(() => {
                let mins = Math.floor(timeLeft / 60);
                let secs = timeLeft % 60;
                timerEl.innerText = `${mins}:${secs < 10 ? '0'+secs : secs}`;
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    submitQuiz();
                }
                timeLeft--;
            }, 1000);
        }

        window.submitQuiz = async () => {
            if(!confirm("Are you sure you want to finish?")) return;

            let score = 0;
            answers.forEach((ans, i) => {
                if(ans === null) return;
                if(ans === quizQuestions[i].correct) score += 1;
                else score -= (1/3);
            });

            // Prepare Google Form URL
            const finalScore = score.toFixed(2);
            const timeTaken = `${30 - Math.ceil(timeLeft/60)} mins`;
            const googleUrl = `https://docs.google.com/forms/d/e/${FORM_ID}/formResponse?${ENTRIES.name}=${encodeURIComponent(userName)}&${ENTRIES.score}=${finalScore}&${ENTRIES.time}=${encodeURIComponent(timeTaken)}&submit=Submit`;

            // Submit using No-CORS fetch
            fetch(googleUrl, { mode: 'no-cors' });
        };
    </script>
</body>
</html>
